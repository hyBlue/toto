{% extends 'base.html' %}
{% load static %}

{% block head_content %}
  <input hidden id="gid" value={{gid}}>
  <link rel="stylesheet" href="{% static 'FlipClock-master/compiled/flipclock.css' %}">
{% endblock head_content %}

{% block body_content %}

  <div class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <h1 class="text-center">
            <span class="display-3 text-primary" style="font-weight:bold;margin-right:10px" name="teamA"></span>
            vs
            <span class="display-3 text-primary" style="font-weight:bold;margin-left:10px" name="teamB"></span>
          </h1>
          <h3 class="text-center text-secondary" style="font-weight:bold" id="league"></h3>
          <h6 class="text-center" id="time"></h6>
        </div>
      </div>
    </div>
  </div>

  <!-- Counter -->
  <div class="container">
    <div class="row">
      <div class="col-xl-12 mx auto">
        <div class="mb-5">
          <div class="form-row col-md-8 mx-auto">
            <div class="clock"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Betting -->
  <div class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-xl-9 mx-auto">
          <div class="mb-5">
            <div class="form-row col-md-12 mx-auto">
              <div class="col-md-4">
                <select class="form-control" id="result_selected">
                  <optgroup label="Select Team">
                    <option disabled selected hidden>Select Team</option>
                    <option name="teamA" value="0"></option>
                    <option name="teamB" value="1"></option>
                    <option value="2">Draw</option>
                  </optgroup>
                </select>
              </div>
              <span class="col-md-1"></span>
              <input class="form-control col-md-3" type="number" id="ether_amount" min="0" max="100" placeholder=" Ether Amount">
              <span class="col-md-1"></span>
              <input class="form-control col-md-3" type="number" id="token_amount" min="0" max="10000" placeholder=" No.tokens"><br>
            </div>
            <div class="form-row col-md-12 mx-auto" style="margin-top:50px">
              <button class="col-md-6 btn btn-outline-primary" style="margin:auto" onclick="betGame()">Submit</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enter Result -->
  <div class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-xl-9 mx-auto">
          <div class="mb-5">
            <div class="form-row col-md-12 mx-auto">
              <div class="col-md-5">
                <select class="form-control" id="result_entered">
                  <optgroup label="Select Team">
                    <option disabled selected hidden>Select Team</option>
                    <option name="teamA" value="0"></option>
                    <option name="teamB" value="1"></option>
                    <option value="2">Draw</option>
                  </optgroup>
                </select>
              </div>
              <span class="col-md-2"></span>
              <input class="form-control col-md-5" type="number" id="result_token_amount" min="0" max="10000" placeholder=" No.tokens"><br>
            </div>
            <div class="form-row col-md-12 mx-auto" style="margin-top:50px">
              <button class="col-md-6 btn btn-outline-primary" style="margin:auto" onclick="enterResult()">Submit</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Betting info -->
  <div>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="col-md-4" style="background-color:rgb(30,30,30);float:left;">
            <h5 name="teamA" class="text-center" style="margin-top:10px;font-weight:bold"></h5><br><br>
            <img src="{% static 'img/ethereum.jpg' %}" width="25"><span id="total_ether_A"> Total Ether Betted: </span><br>
            <img src="{% static 'img/Blank_BitCoin_Logo_Graphic.png' %}" width="20"><span id="total_token_A"> Total Token Betted: </span><br>
            <br>
          </div>
          <div class="col-md-4" style="background-color:rgb(40,40,40);float:left;">
            <h5 name="DRAW" class="text-center" style="margin-top:10px;font-weight:bold">DRAW</h5><br><br>

            <img src="{% static 'img/ethereum.jpg' %}" width="25"><span id="total_ether_DRAW"> Total Ether Betted: </span><br>
            <img src="{% static 'img/Blank_BitCoin_Logo_Graphic.png' %}" width="20"><span id="total_token_DRAW"> Total Token Betted: </span><br>
            <br>
          </div>

          <div class="col-md-4" style="background-color:rgb(30,30,30);float:right;">
            <h5 name="teamB" class="text-center" style="margin-top:10px;font-weight:bold"></h5><br><br>

            <img src="{% static 'img/ethereum.jpg' %}" width="25"><span id="total_ether_B"> Total Ether Betted: </span><br>
            <img src="{% static 'img/Blank_BitCoin_Logo_Graphic.png' %}" width="20"><span id="total_token_B"> Total Token Betted: </span><br>
            <br>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div class="progress">
            <div class="progress-bar progress-bar-striped" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">50%</div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock body_content %}

{% block script_content %}

  <script src="{% static 'FlipClock-master/compiled/flipclock.min.js' %}"></script>
  <script src="{% static 'FlipClock-master/compiled/flipclock.min.js' %}"></script>

  <script type="text/javascript">
		var clock;

		$(document).ready(function() {
			var clock;

			clock = $('.clock').FlipClock({
		        clockFace: 'DailyCounter',
		        autoStart: false,
		        callbacks: {
		        	stop: function() {
		        		$('.message').html('The clock has stopped!')
		        	}
		        }
		    });

		    clock.setTime(220880);
		    clock.setCountdown(true);
		    clock.start();

		});
	</script>

  <script>
  // Script related to web3


  var gameAddr;
  var game;
  var gid;

  function init(){
    Toto = web3.eth.contract(mainAbi);
    Game = web3.eth.contract(gameAbi);
    gid = document.getElementById("gid").value;

    console.log(contractAddress);

    Toto.at(contractAddress, function(e, instance) {
      toto = instance;
      instance.getGames(function(e,r){
        if(e) {
          console.log(e);
          return;
        }
        if (gid > r.length) console.log("Unexisting Game");  // TODO: 404 error handling
        let gameAddr = r[gid];

        game = Game.at(gameAddr);
        getGameInfo();
        getBettingInfo();
      });
    });
  }

  function getGameInfo() {
    game.getGameInfo(function(e,r) {
      let gameStr = r[1];
      let info = gameStr.split(":");

      let league = info[0];
      let A = info[1];
      let B = info[2];

      let timestamp = r[2].toNumber();

      let dt = parseTimestamp(timestamp);
      let hour = dt.hour
      let noon = "AM";

      if (dt.hour > 12){
        dt.hour -= 12;
        noon = "PM";
      }

      let time = `${dt.year}/${dt.month}/${dt.day} - ${noon} ${dt.hour}:${dt.minute}`

      let teamA_elements = document.getElementsByName("teamA");
      let teamB_elements = document.getElementsByName("teamB");

      for (var i=0; i<teamA_elements.length; ++i){
        teamA_elements[i].innerHTML = A;
      }

      for (var i=0; i<teamB_elements.length; ++i){
        teamB_elements[i].innerHTML = B;
      }

      document.getElementById("league").innerHTML = league;
      document.getElementById("time").innerHTML = time;

    });
  }

  function getBettingInfo() {
    game.getBettingInfo(function(e,r){
      if(e) {
        console.log(e);
        return;
      }
      document.getElementById("total_ether_A").innerHTML += web3.fromWei(r[0].toNumber(), 'ether') + ' ETH';
      document.getElementById("total_token_A").innerHTML += r[1].toNumber() + ' SCT';

      document.getElementById("total_ether_B").innerHTML += web3.fromWei(r[2].toNumber(), 'ether') + ' ETH';
      document.getElementById("total_token_B").innerHTML += r[3].toNumber() + ' SCT';

      document.getElementById("total_ether_DRAW").innerHTML += web3.fromWei(r[4].toNumber(), 'ether') + ' ETH';
      document.getElementById("total_token_DRAW").innerHTML += r[5].toNumber() + ' SCT';

    });
  }

  function betGame() {
    var result_opt = document.getElementById('result_selected');
    var result = parseInt(result_opt[result_opt.selectedIndex].value);

    var etherAmount = document.getElementById('ether_amount').value;
    var tokenAmount = parseInt(document.getElementById('token_amount').value);

    console.log(result);
    console.log(etherAmount);
    console.log(tokenAmount);

    toto.betGame(gid, tokenAmount, result, {value:web3.toWei(etherAmount, 'ether')}, function(e,r){
      if (e){
        console.log(e);
        return;
      }
    });
  }

  function enterResult() {
    var result_opt = document.getElementById('result_entered');
    var result = parseInt(result_opt[result_opt.selectedIndex].value);

    var tokenAmount = parseInt(document.getElementById('result_token_amount').value);

    console.log(result);
    console.log(tokenAmount);

    toto.enterResult(gid, tokenAmount, result, function(e,r) {
      if (e) {
        console.log(e);
        return;
      }
    });
  }

  </script>

  <pingendo onclick="window.open('https://pingendo.com/', '_blank')" style="cursor:pointer;position: fixed;bottom: 10px;right:10px;padding:4px;background-color: #00b0eb;border-radius: 8px; width:180px;display:flex;flex-direction:row;align-items:center;justify-content:center;font-size:14px;color:white">Made with Pingendo&nbsp;&nbsp;
    <img src="https://pingendo.com/site-assets/Pingendo_logo_big.png" class="d-block" alt="Pingendo logo" height="16">
  </pingendo>
{% endblock script_content %}
