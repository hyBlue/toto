{% extends 'base.html' %}
{% load static %}

{% block head_content %}
{% endblock head_content %}

{% block body_content %}

  <!-- Table -->
  <div class="py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <table class="table">
            <thead><h1 class="text-center text-primary">CREATE INFO</h1>
              <tr>
                <th>id</th>
                <th>League</th>
                <th>Game</th>
                <th>Start Time</th>
                <th>Status</th>
                <th>SCT Amount</th>
              </tr>
            </thead>
            <tbody id="create_info">
            </tbody>
          </table>
        </div>


        <div class = "col-md-12">
          <table class="table">
            <thead><h1 class="text-center text-primary">BET INFO</h1>
              <tr>
                <th>id</th>
                <th>League</th>
                <th>Game</th>
                <th>Start Time</th>
                <th>Status</th>
                <th>Result</th>
                <th>ETH Amount</th>
                <th>SCT Amount</th>
              </tr>
            </thead>
            <tbody id="betting_info">
            </tbody>
          </table>
        </div>

        <div class = "col-md-12">
          <table class="table">
            <thead><h1 class="text-center text-primary">VERIFY INFO</h1>
              <tr>
                <th>id</th>
                <th>League</th>
                <th>Game</th>
                <th>Start Time</th>
                <th>Status</th>
                <th>Result</th>
                <th>SCT Amount</th>
              </tr>
            </thead>
            <tbody id="verifying_info">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


{% endblock body_content %}

{% block script_content %}

  <!-- Datetime picker -->
  <script type="text/javascript" src='{% static "datetimepicker/jquery/jquery-1.8.3.min.js" %}' charset="UTF-8"></script>
  <script type="text/javascript" src='{% static "datetimepicker/bootstrap/js/bootstrap.min.js" %}'></script>

  <script>
  // Script related to web3

  var games;
  var accountAddr;
  var toto;

  function init(){

    Toto = web3.eth.contract(mainAbi);
    Game = web3.eth.contract(gameAbi);

    createInstance()
      .then(getGames)
      .then(getAccount)
      .then(getTableContents) // end accountInfo

  }

  function createInstance() {
    return new Promise(function(resolve, reject) {
      Toto.at(contractAddress, function(e, instance) {
        toto = instance;
        resolve(toto);
      })
    });
  }

  function getAccount(){
    return new Promise(function(resolve, reject){
      web3.eth.getAccounts(function(e,r) {
        if(e) console.log(e);

        else if (r.length > 0) { accountAddr = r[0]; resolve(accountAddr) }
        else alert('Please login to metamask first!');

      });
    });
  }

  function getGames() {
    return new Promise(function(resolve, reject){
      toto.getGames(function(e,r) {
        if (e) console.log(e);
        else {
          games = r;
          for (var i=0; i<games.length; ++i){
            games[i] = Game.at(games[i]);
          }
          resolve(games);
        }
      });
    });
  }

  function getTableContents() {
    return new Promise(function(resolve, reject){
      toto.accountInfo(accountAddr, function(e, r){
        if (e) console.log(e);
        let createInfo = r[0];
        let partInfo = r[1];
        let verifyInfo = r[2];

        for (var i=0; i<createInfo.length; i+=2){
          let idx = i;
          let gid = verifyInfo[i].toNumber();

          getGameInfo(gid).then(info => {
            let league = info[0];
            let A_B_DRAW = info[1];
            let time = info[2];
            let status = info[3];

            document.getElementById("create_info").innerHTML +=
                `<tr>
                  ${getGameInfoTds(gid, league, A_B_DRAW, time, status)}
                  <td>${createInfo[idx+1]} SCT</td>
                </tr>`;
          })

        }

        for(var i = 0 ; i < partInfo.length; i = i + 4){
          let idx = i;
          let gid = partInfo[i].toNumber();
          let rid = partInfo[i+1].toNumber();

          getGameInfo(gid).then(info => {
            let league = info[0];
            let A_B_DRAW = info[1];
            let time = info[2];
            let status = info[3];
            let result = A_B_DRAW[rid];

            document.getElementById("betting_info").innerHTML +=
                `<tr>
                  ${getGameInfoTds(gid, league, A_B_DRAW, time, status)}
                  <td>${result}</td>
                  <td>${web3.fromWei(partInfo[idx+2],'ether')} ETH</td>
                  <td>${partInfo[idx+3]} SCT</td>
                </tr>`;
          })
        }

        for(var i = 0 ; i < verifyInfo.length; i = i + 3){
            let idx = i;
            let gid = verifyInfo[i].toNumber();
            let rid = verifyInfo[i+1].toNumber();

            getGameInfo(gid).then(info => {
              let league = info[0];
              let A_B_DRAW = info[1];
              let time = info[2];
              let status = info[3];
              let result = A_B_DRAW[rid];

              document.getElementById("verifying_info").innerHTML +=
                `<tr>
                  ${getGameInfoTds(gid, league, A_B_DRAW, time, status)}
                  <td>${result}</td>
                  <td>${verifyInfo[idx+2]} SCT</td>
                </tr>`;
            })
        }
      })
    })
  }

  function getGameInfoTds(gid, league, A_B_DRAW, time, status) {
    return `<td>${gid}</td>
            <td>${league}</td>
            <td style="font-weight:bold"><a href='/home/game/${gid}'>${A_B_DRAW[0]} : ${A_B_DRAW[1]}</a></td>
            <td>${time}</td>
            <td><label class="label" style="background-color: ${gameStatusColor[status]}; color:white">${gameStatus[status]}</label></td>`;;
  }

  function getGameInfo(gid){
    return new Promise(function(resolve, reject) {
      games[gid].getGameInfo(function(e,r) {
        let gameStr = r[1];
        let info = gameStr.split(":");

        let league = info[0];
        let A_B_DRAW = [info[1], info[2], 'DRAW'];
        let startTime = r[2].toNumber();

        let dt = parseTimestamp(startTime);
        let noon = "AM";
        let status;

        if (dt.hour > 12){
          dt.hour -= 12;
          noon = "PM";
        }

        let time = `${dt.year}/${dt.month}/${dt.day} - ${noon} ${dt.hour}:${dt.minute}`;

        toto.isGameClosed(gid, function(e,r){
          if (r) status = 3;
          else status = getStatus(startTime);

          resolve([league, A_B_DRAW, time, status]);
        });//end isGameClosed
      }); //end getGameInfo
    }); //end Promise
  }

</script>

{% endblock script_content %}
